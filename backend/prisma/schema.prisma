generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                                        Int                      @id @default(autoincrement())
  email                                                     String                   @unique
  password                                                  String
  firstName                                                 String
  lastName                                                  String
  middleName                                                String?
  title                                                     String?
  role                                                      UserRole
  status                                                    UserStatus               @default(PENDING_VERIFICATION)
  lastLogin                                                 DateTime?
  emailVerified                                             Boolean                  @default(false)
  twoFactorEnabled                                          Boolean                  @default(false)
  phone                                                     String?
  dateOfBirth                                               DateTime?
  gender                                                    String?
  nationality                                               String?
  address                                                   String?
  createdAt                                                 DateTime                 @default(now())
  updatedAt                                                 DateTime                 @updatedAt
  institutionId                                             Int?
  facultyId                                                 Int?
  departmentId                                              Int?
  calendarImports                                           AcademicCalendarImport[]
  academicPeriodsCreated                                    AcademicPeriod[]
  adminProfiles                                             AdminProfile?
  auditLogs                                                 AuditLog[]
  batchScriptsAssigned                                      BatchScript[]            @relation("BatchScriptsAssigned")
  batchScriptsSealed                                        BatchScript[]            @relation("BatchScriptsSealed")
  courseLecturers                                           CourseLecturer[]
  courseOfferings                                           CourseOffering[]
  registrationsAdvised                                      CourseRegistration[]     @relation("RegistrationAdvisors")
  registrationsApproved                                     CourseRegistration[]     @relation("RegistrationApprovers")
  courseRegistrations                                       CourseRegistration[]     @relation("StudentRegistrations")
  departmentsAsHOD                                          Department[]             @relation("DepartmentHOD")
  enrollments                                               Enrollment[]
  examOfficerProfiles                                       ExamOfficerProfile?
  attendanceMarked                                          ExamRegistration[]       @relation("AttendanceMarkers")
  examRegistrations                                         ExamRegistration[]       @relation("StudentExamRegistrations")
  scriptsSubmittedTo                                        ExamRegistration[]       @relation("ScriptSubmittedTo")
  timetablesApproved                                        ExamTimetable[]          @relation("TimetableApprover")
  timetablesCreated                                         ExamTimetable[]          @relation("TimetableCreator")
  timetablesPublished                                       ExamTimetable[]          @relation("TimetablePublisher")
  facultiesAsDean                                           Faculty[]                @relation("FacultyDean")
  facultyProfiles                                           FacultyAdminProfile?
  incidentsAssigned                                         Incident[]               @relation("AssignedTo")
  incidentsReported                                         Incident[]               @relation("ReportedBy")
  invigilatorProfiles                                       InvigilatorProfile?
  lecturerDepartments                                       LecturerDepartment[]
  lecturerProfiles                                          LecturerProfile?
  scriptHandlerProfiles                                     ScriptHandlerProfile?
  movementsTo                                               ScriptMovement[]         @relation("MovementTo")
  scriptsHolding                                            Script[]                 @relation("ScriptsHolding")
  scriptsGraded                                             Script[]                 @relation("ScriptsGraded")
  academicHistory                                           StudentAcademicHistory?  @relation("StudentAcademicHistory")
  assessmentsGraded                                         StudentAssessment[]      @relation("GradedBy")
  studentAssessments                                        StudentAssessment[]
  studentProfiles                                           StudentProfile?
  semesterRecords                                           StudentSemesterRecord[]  @relation("StudentSemesterRecords")
  conflictsResolved                                         TimetableConflict[]
  timetableImports                                          TimetableImport[]
  department                                                Department?              @relation(fields: [departmentId], references: [id])
  faculty                                                   Faculty?                 @relation(fields: [facultyId], references: [id])
  institution                                               Institution?             @relation(fields: [institutionId], references: [id])

  @@index([institutionId, role])
  @@index([facultyId, role])
  @@index([email, status])
  @@map("users")
}

model AdminProfile {
  id                 Int     @id @default(autoincrement())
  userId             Int     @unique
  permissions        Json
  canManageFaculties Boolean @default(true)
  canManageUsers     Boolean @default(true)
  canViewAnalytics   Boolean @default(true)
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admin_profiles")
}

model FacultyAdminProfile {
  id                   Int     @id @default(autoincrement())
  userId               Int     @unique
  permissions          Json
  canManageDepartments Boolean @default(true)
  canCreateExams       Boolean @default(true)
  canManageOfficers    Boolean @default(true)
  canViewFacultyData   Boolean @default(true)
  user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("faculty_admin_profiles")
}

model ExamOfficerProfile {
  id                    Int     @id @default(autoincrement())
  userId                Int     @unique
  permissions           Json
  canScheduleExams      Boolean @default(true)
  canManageIncidents    Boolean @default(true)
  canAssignInvigilators Boolean @default(true)
  canManageVenues       Boolean @default(true)
  user                  User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("exam_officer_profiles")
}

model ScriptHandlerProfile {
  id                 Int     @id @default(autoincrement())
  userId             Int     @unique
  permissions        Json
  canReceiveScripts  Boolean @default(true)
  canDispatchScripts Boolean @default(true)
  canScanQrCodes     Boolean @default(true)
  canReportIncidents Boolean @default(true)
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("script_handler_profiles")
}

model InvigilatorProfile {
  id                 Int     @id @default(autoincrement())
  userId             Int     @unique
  permissions        Json
  canConductExams    Boolean @default(true)
  canReportIncidents Boolean @default(true)
  canManageScripts   Boolean @default(true)
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("invigilator_profiles")
}

model LecturerProfile {
  id                   Int                @id @default(autoincrement())
  userId               Int                @unique
  staffId              String             @unique
  academicRank         AcademicRankLevel?
  employmentType       EmploymentType     @default(FULL_TIME)
  employmentStatus     EmploymentStatus   @default(ACTIVE)
  hireDate             DateTime?
  highestQualification String?
  specialization       String?
  researchInterests    String?
  officeLocation       String?
  officeHours          String?
  biography            String?
  profileImageUrl      String?
  permissions          Json
  canCreateExams       Boolean            @default(true)
  canGradeScripts      Boolean            @default(true)
  canViewResults       Boolean            @default(true)
  canTeachCourses      Boolean            @default(true)
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("lecturer_profiles")
}

model StudentProfile {
  id                 Int              @id @default(autoincrement())
  userId             Int              @unique
  studentId          String           @unique
  indexNumber        String?          @unique
  level              Int
  semester           Int              @default(1)
  academicYear       String?
  programId          Int?
  admissionDate      DateTime?
  expectedGraduation DateTime?
  enrollmentStatus   EnrollmentStatus @default(ACTIVE)
  academicStatus     AcademicStatus   @default(GOOD_STANDING)
  guardianName       String?
  guardianPhone      String?
  guardianEmail      String?
  emergencyContact   String?
  program            Program?         @relation(fields: [programId], references: [id])
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("student_profiles")
}

model Institution {
  id              Int                      @id @default(autoincrement())
  name            String
  code            String                   @unique
  type            String                   @default("UNIVERSITY")
  status          String                   @default("ACTIVE")
  establishedYear Int?
  address         String?
  city            String?
  state           String?
  country         String?
  contactEmail    String?
  contactPhone    String?
  website         String?
  description     String?
  logoUrl         String?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  calendarImports AcademicCalendarImport[]
  academicYears   AcademicYear[]
  examTimetables  ExamTimetable[]
  faculties       Faculty[]
  users           User[]
  venues          Venue[]

  @@map("institutions")
}

model Faculty {
  id              Int             @id @default(autoincrement())
  name            String
  code            String
  description     String?
  establishedYear Int?
  institutionId   Int
  deanId          Int?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  departments     Department[]
  examTimetables  ExamTimetable[]
  exams           Exam[]
  dean            User?           @relation("FacultyDean", fields: [deanId], references: [id])
  institution     Institution     @relation(fields: [institutionId], references: [id])
  users           User[]

  @@unique([institutionId, code])
  @@map("faculties")
}

model Department {
  id                  Int                  @id @default(autoincrement())
  name                String
  code                String
  type                String               @default("department")
  description         String?
  officeLocation      String?
  contactInfo         String?
  facultyId           Int
  hodId               Int?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  courses             Course[]
  faculty             Faculty              @relation(fields: [facultyId], references: [id])
  hod                 User?                @relation("DepartmentHOD", fields: [hodId], references: [id])
  lecturerDepartments LecturerDepartment[]
  programs            Program[]
  users               User[]

  @@unique([facultyId, code])
  @@map("departments")
}

model Program {
  id                    Int              @id @default(autoincrement())
  name                  String
  code                  String
  type                  ProgramType
  level                 ProgramLevel
  durationYears         Float
  creditHours           Int?
  description           String?
  admissionRequirements String?
  isActive              Boolean          @default(true)
  departmentId          Int
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  programCourses        ProgramCourse[]
  department            Department       @relation(fields: [departmentId], references: [id])
  students              StudentProfile[]

  @@unique([departmentId, code])
  @@map("programs")
}

model ProgramPrefix {
  id          Int         @id @default(autoincrement())
  programType ProgramType @unique
  prefix      String
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("program_prefixes")
}

model Course {
  id                Int                  @id @default(autoincrement())
  name              String
  code              String               @unique
  description       String?
  creditHours       Int                  @default(3)
  contactHours      Int?
  level             Int
  courseType        CourseType           @default(CORE)
  prerequisites     String?
  corequisites      String?
  learningOutcomes  String?
  syllabus          String?
  assessmentMethods String?
  recommendedBooks  String?
  departmentId      Int
  isActive          Boolean              @default(true)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  batchScripts      BatchScript[]
  courseOfferings   CourseOffering[]
  department        Department           @relation(fields: [departmentId], references: [id])
  enrollments       Enrollment[]
  timetableEntries  ExamTimetableEntry[]
  exams             Exam[]
  programCourses    ProgramCourse[]

  @@map("courses")
}

model ProgramCourse {
  id                    Int      @id @default(autoincrement())
  programId             Int
  courseId              Int
  level                 Int
  semester              Int
  isRequired            Boolean  @default(true)
  createdAt             DateTime @default(now())
  isCore                Boolean  @default(true)
  offeredInSemester1    Boolean  @default(true)
  offeredInSemester2    Boolean  @default(false)
  prerequisiteCourseIds String?
  updatedAt             DateTime @updatedAt
  yearInProgram         Int      @default(1)
  course                Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  program               Program  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, courseId, level, semester])
  @@map("program_courses")
}

model AcademicYear {
  id             Int             @id @default(autoincrement())
  yearCode       String          @unique
  startDate      DateTime
  endDate        DateTime
  isCurrent      Boolean         @default(false)
  institutionId  Int
  createdAt      DateTime        @default(now())
  institution    Institution     @relation(fields: [institutionId], references: [id])
  examTimetables ExamTimetable[]
  semesters      Semester[]

  @@map("academic_years")
}

model Semester {
  id                  Int                     @id @default(autoincrement())
  academicYearId      Int
  semesterNumber      Int
  name                String
  startDate           DateTime
  endDate             DateTime
  isCurrent           Boolean                 @default(false)
  createdAt           DateTime                @default(now())
  academicPeriod      AcademicPeriod?
  courseOfferings     CourseOffering[]
  courseRegistrations CourseRegistration[]
  enrollments         Enrollment[]
  examTimetables      ExamTimetable[]
  academicYear        AcademicYear            @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  semesterRecords     StudentSemesterRecord[]

  @@unique([academicYearId, semesterNumber])
  @@map("semesters")
}

model AcademicPeriod {
  id                    Int             @id @default(autoincrement())
  semesterId            Int             @unique
  registrationStartDate DateTime
  registrationEndDate   DateTime
  addDropStartDate      DateTime?
  addDropEndDate        DateTime?
  lectureStartDate      DateTime
  lectureEndDate        DateTime
  examStartDate         DateTime
  examEndDate           DateTime
  resultsReleaseDate    DateTime?
  maxCreditsPerStudent  Int             @default(24)
  minCreditsPerStudent  Int             @default(12)
  lateRegistrationFee   Float?
  isActive              Boolean         @default(true)
  isRegistrationOpen    Boolean         @default(false)
  isAddDropOpen         Boolean         @default(false)
  notes                 String?
  createdBy             Int?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  creator               User?           @relation(fields: [createdBy], references: [id])
  semester              Semester        @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  examTimetables        ExamTimetable[]

  @@map("academic_periods")
}

model AcademicCalendarImport {
  id               Int                  @id @default(autoincrement())
  institutionId    Int
  fileName         String
  fileUrl          String?
  fileType         CalendarFileType
  fileSize         Int?
  status           CalendarImportStatus @default(PENDING)
  recordsTotal     Int                  @default(0)
  recordsImported  Int                  @default(0)
  recordsFailed    Int                  @default(0)
  errorLog         String?
  validationErrors String?
  importMapping    String?
  importOptions    String?
  importedBy       Int
  importedAt       DateTime             @default(now())
  completedAt      DateTime?
  importer         User                 @relation(fields: [importedBy], references: [id])
  institution      Institution          @relation(fields: [institutionId], references: [id])

  @@map("academic_calendar_imports")
}

model CourseOffering {
  id                Int                @id @default(autoincrement())
  courseId          Int
  semesterId        Int
  primaryLecturerId Int?
  maxEnrollment     Int?
  currentEnrollment Int                @default(0)
  classroom         String?
  schedule          String?
  status            String             @default("active")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  assessments       Assessment[]
  courseLecturers   CourseLecturer[]
  course            Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  primaryLecturer   User?              @relation(fields: [primaryLecturerId], references: [id])
  semester          Semester           @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  enrollments       Enrollment[]
  registeredCourses RegisteredCourse[]

  @@unique([courseId, semesterId])
  @@map("course_offerings")
}

model CourseLecturer {
  id               Int            @id @default(autoincrement())
  courseOfferingId Int
  lecturerId       Int
  role             String         @default("instructor")
  createdAt        DateTime       @default(now())
  courseOffering   CourseOffering @relation(fields: [courseOfferingId], references: [id], onDelete: Cascade)
  lecturer         User           @relation(fields: [lecturerId], references: [id], onDelete: Cascade)

  @@unique([courseOfferingId, lecturerId])
  @@map("course_lecturers")
}

model LecturerDepartment {
  id           Int        @id @default(autoincrement())
  lecturerId   Int
  departmentId Int
  isPrimary    Boolean    @default(false)
  role         String?
  createdAt    DateTime   @default(now())
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  lecturer     User       @relation(fields: [lecturerId], references: [id], onDelete: Cascade)

  @@unique([lecturerId, departmentId])
  @@map("lecturer_departments")
}

model Enrollment {
  id                   Int            @id @default(autoincrement())
  studentId            Int
  courseOfferingId     Int
  enrollmentDate       DateTime       @default(now())
  status               String         @default("enrolled")
  grade                String?
  gradePoints          Float?
  attendancePercentage Float?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  courseId             Int
  semesterId           Int
  course               Course         @relation(fields: [courseId], references: [id])
  courseOffering       CourseOffering @relation(fields: [courseOfferingId], references: [id], onDelete: Cascade)
  semester             Semester       @relation(fields: [semesterId], references: [id])
  student              User           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseOfferingId])
  @@map("enrollments")
}

model CourseRegistration {
  id                Int                @id @default(autoincrement())
  studentId         Int
  semesterId        Int
  status            RegistrationStatus @default(DRAFT)
  totalCredits      Int                @default(0)
  approvedBy        Int?
  advisorId         Int?
  submittedAt       DateTime?
  approvedAt        DateTime?
  rejectedAt        DateTime?
  rejectionReason   String?
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  advisor           User?              @relation("RegistrationAdvisors", fields: [advisorId], references: [id])
  approver          User?              @relation("RegistrationApprovers", fields: [approvedBy], references: [id])
  semester          Semester           @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  student           User               @relation("StudentRegistrations", fields: [studentId], references: [id], onDelete: Cascade)
  registeredCourses RegisteredCourse[]

  @@unique([studentId, semesterId])
  @@index([studentId, status])
  @@index([semesterId, status])
  @@map("course_registrations")
}

model RegisteredCourse {
  id                    Int                @id @default(autoincrement())
  registrationId        Int
  courseOfferingId      Int
  registrationType      RegistrationType   @default(REGULAR)
  prerequisitesMet      Boolean            @default(true)
  prerequisitesOverride Boolean            @default(false)
  overrideReason        String?
  isLocked              Boolean            @default(false)
  droppedAt             DateTime?
  dropReason            String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  courseOffering        CourseOffering     @relation(fields: [courseOfferingId], references: [id], onDelete: Cascade)
  registration          CourseRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@unique([registrationId, courseOfferingId])
  @@index([registrationId])
  @@index([courseOfferingId])
  @@map("registered_courses")
}

model StudentSemesterRecord {
  id                 Int              @id @default(autoincrement())
  studentId          Int
  semesterId         Int
  coursesRegistered  Int              @default(0)
  coursesCompleted   Int              @default(0)
  coursesFailed      Int              @default(0)
  coursesDropped     Int              @default(0)
  coursesInProgress  Int              @default(0)
  creditsAttempted   Int              @default(0)
  creditsEarned      Int              @default(0)
  semesterGPA        Float?
  cumulativeGPA      Float?
  totalGradePoints   Float            @default(0)
  totalCreditsEarned Int              @default(0)
  academicStanding   AcademicStanding @default(GOOD_STANDING)
  isOnProbation      Boolean          @default(false)
  probationCount     Int              @default(0)
  remarksFromAdvisor String?
  isFinalized        Boolean          @default(false)
  finalizedAt        DateTime?
  finalizedBy        Int?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  semester           Semester         @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  student            User             @relation("StudentSemesterRecords", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, semesterId])
  @@index([studentId])
  @@index([semesterId])
  @@map("student_semester_records")
}

model StudentAcademicHistory {
  id                      Int              @id @default(autoincrement())
  studentId               Int              @unique
  admissionYear           String
  admissionSemester       Int              @default(1)
  expectedGraduationYear  String?
  currentLevel            Int              @default(100)
  currentSemester         Int              @default(1)
  totalSemestersCompleted Int              @default(0)
  cumulativeGPA           Float?
  overallCreditsEarned    Int              @default(0)
  overallCreditsAttempted Int              @default(0)
  currentStatus           AcademicStanding @default(GOOD_STANDING)
  hasGraduated            Boolean          @default(false)
  graduationDate          DateTime?
  levelProgressionHistory String?
  probationHistory        String?
  awardsAndHonors         String?
  lastUpdated             DateTime         @updatedAt
  createdAt               DateTime         @default(now())
  student                 User             @relation("StudentAcademicHistory", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("student_academic_history")
}

model AssessmentType {
  id            Int          @id @default(autoincrement())
  name          String       @unique
  description   String?
  defaultWeight Float?
  assessments   Assessment[]

  @@map("assessment_types")
}

model Assessment {
  id                 Int                 @id @default(autoincrement())
  courseOfferingId   Int
  assessmentTypeId   Int
  title              String
  description        String?
  totalMarks         Float
  weightPercentage   Float
  dueDate            DateTime?
  instructions       String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  assessmentType     AssessmentType      @relation(fields: [assessmentTypeId], references: [id])
  courseOffering     CourseOffering      @relation(fields: [courseOfferingId], references: [id], onDelete: Cascade)
  studentAssessments StudentAssessment[]

  @@map("assessments")
}

model StudentAssessment {
  id           Int        @id @default(autoincrement())
  assessmentId Int
  studentId    Int
  score        Float?
  submittedAt  DateTime?
  gradedAt     DateTime?
  gradedById   Int?
  feedback     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  gradedBy     User?      @relation("GradedBy", fields: [gradedById], references: [id])
  student      User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, studentId])
  @@map("student_assessments")
}

model Exam {
  id                  Int                  @id @default(autoincrement())
  title               String
  courseId            Int
  facultyId           Int
  examDate            DateTime
  startTime           DateTime
  endTime             DateTime
  duration            Int
  venueId             Int?
  roomId              Int?
  status              ExamStatus           @default(PLANNED)
  instructions        String?
  specialRequirements String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  createdBy           Int
  examSessions        ExamSession[]
  timetableEntries    ExamTimetableEntry[]
  course              Course               @relation(fields: [courseId], references: [id])
  faculty             Faculty              @relation(fields: [facultyId], references: [id])
  room                Room?                @relation(fields: [roomId], references: [id])
  venue               Venue?               @relation(fields: [venueId], references: [id])
  incidents           Incident[]
  scripts             Script[]

  @@map("exams")
}

model ExamSession {
  id              Int       @id @default(autoincrement())
  examId          Int
  sessionDate     DateTime
  startTime       DateTime
  endTime         DateTime
  actualStartTime DateTime?
  actualEndTime   DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  exam            Exam      @relation(fields: [examId], references: [id])

  @@map("exam_sessions")
}

model ExamTimetable {
  id                   Int                     @id @default(autoincrement())
  title                String
  description          String?
  academicYearId       Int
  semesterId           Int
  academicPeriodId     Int?
  institutionId        Int
  facultyId            Int?
  startDate            DateTime
  endDate              DateTime
  status               ExamTimetableStatus     @default(DRAFT)
  isPublished          Boolean                 @default(false)
  publishedAt          DateTime?
  publishedBy          Int?
  approvalStatus       TimetableApprovalStatus @default(NOT_SUBMITTED)
  approvedBy           Int?
  approvedAt           DateTime?
  rejectionReason      String?
  allowOverlaps        Boolean                 @default(false)
  autoResolveConflicts Boolean                 @default(true)
  defaultExamDuration  Int                     @default(180)
  totalExams           Int                     @default(0)
  totalConflicts       Int                     @default(0)
  venuesUtilization    Float?
  createdBy            Int
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  entries              ExamTimetableEntry[]
  academicPeriod       AcademicPeriod?         @relation(fields: [academicPeriodId], references: [id])
  academicYear         AcademicYear            @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  approver             User?                   @relation("TimetableApprover", fields: [approvedBy], references: [id])
  creator              User                    @relation("TimetableCreator", fields: [createdBy], references: [id])
  faculty              Faculty?                @relation(fields: [facultyId], references: [id])
  institution          Institution             @relation(fields: [institutionId], references: [id])
  publisher            User?                   @relation("TimetablePublisher", fields: [publishedBy], references: [id])
  semester             Semester                @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  conflicts            TimetableConflict[]
  imports              TimetableImport[]

  @@index([institutionId, academicYearId, semesterId])
  @@index([status, isPublished])
  @@map("exam_timetables")
}

model ExamTimetableEntry {
  id                  Int                      @id @default(autoincrement())
  timetableId         Int
  examId              Int?
  courseId            Int
  programIds          String
  level               Int?
  studentCount        Int?
  examDate            DateTime
  startTime           DateTime
  endTime             DateTime
  duration            Int
  venueId             Int
  roomIds             String
  seatingCapacity     Int?
  invigilatorIds      String
  chiefInvigilatorId  Int?
  status              ExamTimetableEntryStatus @default(DRAFT)
  notes               String?
  specialRequirements String?
  hasConflicts        Boolean                  @default(false)
  conflictDetails     String?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  batchScripts        BatchScript[]
  examRegistrations   ExamRegistration[]
  course              Course                   @relation(fields: [courseId], references: [id])
  exam                Exam?                    @relation(fields: [examId], references: [id])
  timetable           ExamTimetable            @relation(fields: [timetableId], references: [id], onDelete: Cascade)
  venue               Venue                    @relation(fields: [venueId], references: [id])
  conflictsAsEntry1   TimetableConflict[]      @relation("ConflictEntry1")
  conflictsAsEntry2   TimetableConflict[]      @relation("ConflictEntry2")

  @@index([timetableId, examDate])
  @@index([courseId])
  @@index([venueId, examDate, startTime])
  @@index([status, hasConflicts])
  @@map("exam_timetable_entries")
}

model TimetableConflict {
  id                  String             @id @default(uuid())
  timetableId         Int
  type                ConflictType
  severity            ConflictSeverity   @default(MEDIUM)
  entry1Id            Int
  entry2Id            Int
  additionalEntryIds  String?
  description         String
  affectedStudents    Int?
  affectedPrograms    String?
  canAutoResolve      Boolean            @default(false)
  suggestedResolution String?
  isResolved          Boolean            @default(false)
  resolvedAt          DateTime?
  resolvedBy          Int?
  detectedAt          DateTime           @default(now())
  entry1              ExamTimetableEntry @relation("ConflictEntry1", fields: [entry1Id], references: [id], onDelete: Cascade)
  entry2              ExamTimetableEntry @relation("ConflictEntry2", fields: [entry2Id], references: [id], onDelete: Cascade)
  resolver            User?              @relation(fields: [resolvedBy], references: [id])
  timetable           ExamTimetable      @relation(fields: [timetableId], references: [id], onDelete: Cascade)

  @@index([timetableId, isResolved])
  @@index([type, severity])
  @@map("timetable_conflicts")
}

model TimetableImport {
  id               Int                   @id @default(autoincrement())
  timetableId      Int?
  fileName         String
  fileUrl          String?
  fileType         TimetableFileType
  fileSize         Int?
  status           TimetableImportStatus @default(PENDING)
  totalRecords     Int                   @default(0)
  importedRecords  Int                   @default(0)
  failedRecords    Int                   @default(0)
  skippedRecords   Int                   @default(0)
  errors           String?
  warnings         String?
  importMapping    String?
  importOptions    String?
  validationPassed Boolean               @default(false)
  validationErrors String?
  previewData      String?
  importedBy       Int
  importedAt       DateTime              @default(now())
  completedAt      DateTime?
  importer         User                  @relation(fields: [importedBy], references: [id])
  timetable        ExamTimetable?        @relation(fields: [timetableId], references: [id])

  @@index([timetableId, status])
  @@index([importedBy, importedAt])
  @@map("timetable_imports")
}

model Venue {
  id               Int                  @id @default(autoincrement())
  name             String
  location         String
  capacity         Int
  institutionId    Int
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  timetableEntries ExamTimetableEntry[]
  exams            Exam[]
  rooms            Room[]
  institution      Institution          @relation(fields: [institutionId], references: [id])

  @@map("venues")
}

model Room {
  id        Int      @id @default(autoincrement())
  name      String
  capacity  Int
  venueId   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  exams     Exam[]
  venue     Venue    @relation(fields: [venueId], references: [id])

  @@unique([venueId, name])
  @@map("rooms")
}

model Script {
  id                 Int                @id @default(autoincrement())
  qrCode             String             @unique
  studentId          String
  examId             Int
  status             ScriptStatus       @default(GENERATED)
  notes              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  batchScriptId      Int?
  currentHolderId    Int?
  gradedById         Int?
  score              Float?
  maxScore           Float?
  gradedAt           DateTime?
  exam_registrations ExamRegistration[]
  incidents          Incident[]
  movements          ScriptMovement[]
  batchScript        BatchScript?       @relation(fields: [batchScriptId], references: [id])
  currentHolder      User?              @relation("ScriptsHolding", fields: [currentHolderId], references: [id])
  Exam               Exam               @relation(fields: [examId], references: [id])
  gradedBy           User?              @relation("ScriptsGraded", fields: [gradedById], references: [id])

  @@index([examId, status])
  @@index([batchScriptId])
  @@index([currentHolderId])
  @@map("scripts")
}

model ScriptMovement {
  id            Int          @id @default(autoincrement())
  scriptId      Int
  type          MovementType
  fromUserId    Int?
  toUserId      Int?
  location      String?
  notes         String?
  timestamp     DateTime     @default(now())
  batchScriptId Int?
  batchScript   BatchScript? @relation(fields: [batchScriptId], references: [id])
  script        Script       @relation(fields: [scriptId], references: [id])
  toUser        User?        @relation("MovementTo", fields: [toUserId], references: [id])

  @@index([batchScriptId])
  @@map("script_movements")
}

model ExamRegistration {
  id                 Int                @id @default(autoincrement())
  studentId          Int
  examEntryId        Int
  studentQRCode      String             @unique
  isPresent          Boolean            @default(false)
  attendanceMarkedAt DateTime?
  attendanceMarkedBy Int?
  scriptSubmitted    Boolean            @default(false)
  scriptSubmittedAt  DateTime?
  seatNumber         String?
  specialArrangement String?
  notes              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  submittedTo        Int?               @map("submitted_to")
  batchScriptId      Int?               @map("batch_script_id")
  scriptId           Int?               @map("script_id")
  markedBy           User?              @relation("AttendanceMarkers", fields: [attendanceMarkedBy], references: [id])
  examEntry          ExamTimetableEntry @relation(fields: [examEntryId], references: [id])
  student            User               @relation("StudentExamRegistrations", fields: [studentId], references: [id])
  batchScript        BatchScript?       @relation(fields: [batchScriptId], references: [id], onUpdate: NoAction, map: "fk_exam_registrations_batch_script")
  script             Script?            @relation(fields: [scriptId], references: [id], onUpdate: NoAction, map: "fk_exam_registrations_script")
  submittedToUser    User?              @relation("ScriptSubmittedTo", fields: [submittedTo], references: [id], onUpdate: NoAction, map: "fk_exam_registrations_submitted_to")

  @@unique([studentId, examEntryId])
  @@index([examEntryId, scriptSubmitted])
  @@index([studentId])
  @@index([batchScriptId], map: "idx_exam_registrations_batch_script_id")
  @@map("exam_registrations")
}

model BatchScript {
  id                 Int                @id @default(autoincrement())
  examEntryId        Int
  courseId           Int
  batchQRCode        String             @unique
  status             BatchScriptStatus  @default(PENDING)
  totalRegistered    Int                @default(0)
  scriptsSubmitted   Int                @default(0)
  scriptsCollected   Int                @default(0)
  scriptsGraded      Int                @default(0)
  assignedLecturerId Int?
  sealedAt           DateTime?
  sealedBy           Int?
  deliveredAt        DateTime?
  completedAt        DateTime?
  notes              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  assignedLecturer   User?              @relation("BatchScriptsAssigned", fields: [assignedLecturerId], references: [id])
  course             Course             @relation(fields: [courseId], references: [id])
  examEntry          ExamTimetableEntry @relation(fields: [examEntryId], references: [id])
  sealedByUser       User?              @relation("BatchScriptsSealed", fields: [sealedBy], references: [id])
  exam_registrations ExamRegistration[]
  movements          ScriptMovement[]
  scripts            Script[]

  @@unique([examEntryId, courseId])
  @@index([courseId, status])
  @@index([assignedLecturerId])
  @@map("batch_scripts")
}

model Incident {
  id           Int              @id @default(autoincrement())
  type         IncidentType
  severity     IncidentSeverity @default(MEDIUM)
  status       IncidentStatus   @default(REPORTED)
  title        String
  description  String
  examId       Int?
  scriptId     Int?
  reportedById Int
  assignedToId Int?
  resolution   String?
  resolvedAt   DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  assignedTo   User?            @relation("AssignedTo", fields: [assignedToId], references: [id])
  exam         Exam?            @relation(fields: [examId], references: [id])
  reportedBy   User             @relation("ReportedBy", fields: [reportedById], references: [id])
  script       Script?          @relation(fields: [scriptId], references: [id])

  @@index([examId, status])
  @@map("incidents")
}

model AuditLog {
  id        Int        @id @default(autoincrement())
  userId    Int
  action    ActionType
  entity    String
  entityId  String?
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  timestamp DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id])

  @@index([userId, timestamp])
  @@map("audit_logs")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  FACULTY_ADMIN
  DEAN
  HOD
  EXAMS_OFFICER
  SCRIPT_HANDLER
  INVIGILATOR
  LECTURER
  STUDENT
}

enum AcademicRankLevel {
  GRADUATE_ASSISTANT
  ASSISTANT_LECTURER
  LECTURER
  SENIOR_LECTURER
  PRINCIPAL_LECTURER
  ASSOCIATE_PROFESSOR
  PROFESSOR
}

enum ProgramType {
  CERTIFICATE
  DIPLOMA
  HND
  BACHELOR
  MASTERS
  PHD
}

enum ProgramLevel {
  UNDERGRADUATE
  POSTGRADUATE
}

enum EnrollmentStatus {
  ACTIVE
  DEFERRED
  GRADUATED
  WITHDRAWN
  SUSPENDED
}

enum AcademicStatus {
  GOOD_STANDING
  PROBATION
  SUSPENDED
}

enum CourseType {
  CORE
  ELECTIVE
  GENERAL
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  VISITING
}

enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  RETIRED
  TERMINATED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum CalendarImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

enum CalendarFileType {
  CSV
  EXCEL
  ICAL
  JSON
}

enum RegistrationStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum RegistrationType {
  REGULAR
  RETAKE
  CARRYOVER
  MAKE_UP
}

enum AcademicStanding {
  GOOD_STANDING
  PROBATION
  ACADEMIC_WARNING
  SUSPENDED
  DISMISSED
}

enum ExamStatus {
  PLANNED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

enum ExamTimetableStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

enum TimetableApprovalStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  REJECTED
  REVISION_REQUIRED
}

enum ExamTimetableEntryStatus {
  DRAFT
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum TimetableFileType {
  CSV
  EXCEL
  ICAL
  JSON
  PDF
}

enum TimetableImportStatus {
  PENDING
  VALIDATING
  VALIDATED
  IMPORTING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

enum ConflictType {
  STUDENT_OVERLAP
  VENUE_OVERLAP
  INVIGILATOR_OVERLAP
  CAPACITY_EXCEEDED
  TIME_VIOLATION
  DATE_VIOLATION
  PREREQUISITE_VIOLATION
}

enum ConflictSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ScriptStatus {
  GENERATED
  DISTRIBUTED
  COLLECTED
  VERIFIED
  SCANNED
  DISPATCHED
  RECEIVED_FOR_GRADING
  GRADING_IN_PROGRESS
  GRADED
  RETURNED
}

enum MovementType {
  GENERATED
  DISTRIBUTED_TO_VENUE
  COLLECTED_FROM_STUDENT
  VERIFIED_BY_INVIGILATOR
  SCANNED_BY_HANDLER
  DISPATCHED_TO_GRADER
  RECEIVED_BY_GRADER
  GRADED
  RETURNED_TO_REGISTRY
  BATCH_SEALED
  BATCH_TRANSFERRED
}

enum IncidentType {
  ACADEMIC_MISCONDUCT
  TECHNICAL_ISSUE
  MEDICAL_EMERGENCY
  MISSING_SCRIPT
  DAMAGED_SCRIPT
  LATE_ARRIVAL
  IDENTITY_VERIFICATION
  VENUE_ISSUE
  OTHER
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  REPORTED
  UNDER_INVESTIGATION
  RESOLVED
  CLOSED
  ESCALATED
}

enum ActionType {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum BatchScriptStatus {
  PENDING
  IN_COLLECTION
  SEALED
  IN_TRANSIT
  WITH_LECTURER
  GRADING_IN_PROGRESS
  GRADING_COMPLETED
  RETURNED_TO_REGISTRY
  ARCHIVED
}
